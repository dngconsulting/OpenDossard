services:
  dossarddb:
    container_name: dossarddb
    image: postgres:12-alpine3.20
    volumes:
      - postgres:/var/lib/postgresql/data:rw
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_HOST
      - POSTGRES_PORT
      - POSTGRES_DB
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - MONITORING_PASSWORD
      - MONITORING_USER
      - JWT_SECRET
      - JWT_EXPIRE_SECONDS
  api_webapp:
    container_name: api_webapp
    image: ghcr.io/dngconsulting/opendossard_api_webapp:latest
    command: "npm run start:prod"
    expose:
      - "9090"
    restart: always
    environment:
      - POSTGRES_HOST
      - POSTGRES_PORT
      - POSTGRES_DB
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - MONITORING_PASSWORD
      - MONITORING_USER
      - JWT_SECRET
      - JWT_EXPIRE_SECONDS
      - NODE_ENV="production"
      - TSC_COMPILE_ON_ERROR="true"
      - DISABLE_ESLINT_PLUGIN="true"
      - CI="true"
      - PORT="80"
  # ══════════════════════════════════════════════════════════
  # V2 - NEW SERVICES
  # ══════════════════════════════════════════════════════════
  api-v2:
    container_name: api-v2
    image: ghcr.io/dngconsulting/opendossard_api-v2:latest
    restart: always
    expose:
      - "3001"
    environment:
      - POSTGRES_HOST=dossarddb
      - POSTGRES_PORT=5432
      - POSTGRES_DB
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - JWT_SECRET
      - JWT_ACCESS_EXPIRE
      - JWT_REFRESH_EXPIRE
      - JWT_REFRESH_SECRET
      - NODE_ENV=production
    depends_on:
      - dossarddb

  webapp-v2:
    container_name: webapp-v2
    image: ghcr.io/dngconsulting/opendossard_webapp-v2:latest
    restart: always
    expose:
      - "80"

  # ══════════════════════════════════════════════════════════
  # MONITORING
  # ══════════════════════════════════════════════════════════
  netdata:
    image: netdata/netdata:stable
    container_name: netdata
    hostname: monitoring.opendossard.com
    restart: always
    pid: host
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    expose:
      - "19999"
    volumes:
      - netdataconfig:/etc/netdata
      - netdatalib:/var/lib/netdata
      - netdatacache:/var/cache/netdata
      - ./config/netdata/go.d/nginx.conf:/etc/netdata/go.d/nginx.conf:ro
      - ./config/netdata/go.d/postgres.conf:/etc/netdata/go.d/postgres.conf:ro
      - /etc/passwd:/host/etc/passwd:ro
      - /etc/group:/host/etc/group:ro
      - /etc/localtime:/etc/localtime:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /etc/os-release:/host/etc/os-release:ro
      - /var/log:/host/var/log:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro

  # ══════════════════════════════════════════════════════════
  # REVERSE PROXY
  # ══════════════════════════════════════════════════════════
  website:
    image: nginx:1.27-alpine
    container_name: website
    restart: always
    ports:
      - "443:443"
      - "80:80"
    environment:
      - NETDATA_USER
      - NETDATA_PASSWORD
    command:
      - /bin/sh
      - -c
      - |
        apk add --no-cache apache2-utils > /dev/null 2>&1
        htpasswd -cbB /tmp/auth/netdata.htpasswd "$$NETDATA_USER" "$$NETDATA_PASSWORD"
        exec /docker-entrypoint.sh nginx -g 'daemon off;'
    tmpfs:
      - /tmp/auth
    volumes:
      - ./website/:/var/www/html
      - ./config/nginx.conf:/etc/nginx/nginx.conf
      - ./config/ssl.conf:/etc/nginx/ssl.conf
      - /etc/letsencrypt/live/opendossard.com/fullchain.pem:/etc/letsencrypt/opendossard/cert.pem
      - /etc/letsencrypt/live/opendossard.com/privkey.pem:/etc/letsencrypt/opendossard/key.pem
      - /etc/letsencrypt/live/opendossard.com/dhparam.pem:/etc/letsencrypt/opendossard/dhparam.pem
    depends_on:
      - api_webapp
      - api-v2
      - webapp-v2
      - netdata

volumes:
  postgres:
  netdataconfig:
  netdatalib:
  netdatacache:
